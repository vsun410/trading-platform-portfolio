# ğŸ›¡ï¸ ê¹€ì¹˜í”„ë¦¬ë¯¸ì—„ ë¦¬ìŠ¤í¬ ê´€ë¦¬ í”„ë ˆì„ì›Œí¬ (Ver 3.0)

## 1. ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê°œìš”

### 1.1 í•µì‹¬ ì² í•™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Risk Management Philosophy                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   ğŸ¯ í•µì‹¬ ì›ì¹™: "ì ˆëŒ€ ì†ì ˆí•˜ì§€ ì•ŠëŠ”ë‹¤ (No Stop Loss)"                â”‚
â”‚                                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ì™œ ì†ì ˆí•˜ì§€ ì•ŠëŠ”ê°€?                                         â”‚   â”‚
â”‚   â”‚                                                               â”‚   â”‚
â”‚   â”‚  1. ë¸íƒ€ ë‰´íŠ¸ëŸ´ = ë°©í–¥ì„± ë¦¬ìŠ¤í¬ ì œê±°                         â”‚   â”‚
â”‚   â”‚  2. ê¹€í”„ëŠ” ê²°êµ­ í‰ê·  íšŒê·€ (Mean Reversion)                   â”‚   â”‚
â”‚   â”‚  3. ì†ì ˆ = ìˆ˜ìˆ˜ë£Œ ì†ì‹¤ + ì¬ì§„ì… ë¹„ìš© ë°œìƒ                    â”‚   â”‚
â”‚   â”‚  4. 'Lìí˜• ì¥ì„¸'ë„ Breakout Rescueë¡œ íƒˆì¶œ ê°€ëŠ¥ (Ver 3.0)     â”‚   â”‚
â”‚   â”‚                                                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚   ëŒ€ì‹  ê´€ë¦¬í•˜ëŠ” ë¦¬ìŠ¤í¬:                                              â”‚
â”‚   â”œâ”€ í™˜ìœ¨ ë¦¬ìŠ¤í¬ â†’ í™˜ìœ¨ í•„í„° (ì§„ì… ì°¨ë‹¨)                            â”‚
â”‚   â”œâ”€ ì¥ê¸° ë³´ìœ  ë¦¬ìŠ¤í¬ â†’ Breakout Rescue (íƒˆì¶œêµ¬ ë§ˆë ¨)               â”‚
â”‚   â”œâ”€ ì‹¤í–‰ ë¦¬ìŠ¤í¬ â†’ ë™ì‹œ ì£¼ë¬¸ + ë¡¤ë°± ë©”ì»¤ë‹ˆì¦˜                        â”‚
â”‚   â””â”€ ìê¸ˆ ë¬¶ì„ ë¦¬ìŠ¤í¬ â†’ ì˜ˆë¹„ë¹„ 5% í™•ë³´                              â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Ver 3.0 ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë³€ê²½ì‚¬í•­

| ë¦¬ìŠ¤í¬ | ê¸°ì¡´ ëŒ€ì‘ | Ver 3.0 ëŒ€ì‘ |
|:---|:---|:---|
| í™˜ìœ¨ ê¸‰ë“± | ì—†ìŒ | **í™˜ìœ¨ í•„í„° (ì§„ì… ì°¨ë‹¨)** |
| Lìí˜• ì¥ì„¸ | ë¬´ê¸°í•œ ëŒ€ê¸° | **Breakout Rescue (íƒˆì¶œ)** |
| ì¥ê¸° ë³´ìœ  | íƒ€ì„ì»· (íê¸°ë¨) | **BB ëŒíŒŒ ì‹œ íƒˆì¶œ** |

---

## 2. í™˜ìœ¨ ë¦¬ìŠ¤í¬ ê´€ë¦¬ (Ver 3.0 ì‹ ê·œ)

### 2.1 í™˜ìœ¨ê³¼ ê¹€í”„ì˜ ìƒê´€ê´€ê³„

```
í™˜ìœ¨ ê¸‰ë“± â†’ ê¹€í”„ êµ¬ì¡°ì  í•˜ë½

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚   í™˜ìœ¨ â†‘â†‘       ê¹€í”„ â†“â†“                                     â”‚
â”‚     â”‚             â”‚                                          â”‚
â”‚     â”‚             â””â”€ í•´ì™¸ ê°€ê²© KRW í™˜ì‚°ê°’ ìƒìŠ¹               â”‚
â”‚     â”‚                â†’ êµ­ë‚´ ëŒ€ë¹„ í”„ë¦¬ë¯¸ì—„ ê°ì†Œ               â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€ ë‹¬ëŸ¬ ê°•ì„¸ ì‹œ ì™¸êµ­ì¸ ìê¸ˆ ìœ ì¶œ ê²½í–¥                    â”‚
â”‚        â†’ êµ­ë‚´ ê±°ë˜ì†Œ ë§¤ìˆ˜ì„¸ ì•½í™”                             â”‚
â”‚                                                              â”‚
â”‚   ê²°ë¡ : í™˜ìœ¨ ê¸‰ë“± êµ¬ê°„ì—ì„œ ê¹€í”„ ë¡± ì§„ì… = ì—­í’ ë§ìŒ          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 í™˜ìœ¨ í•„í„° ë¡œì§

```python
class FXRiskManager:
    """í™˜ìœ¨ ë¦¬ìŠ¤í¬ ê´€ë¦¬ì"""
    
    # íŒŒë¼ë¯¸í„°
    MA_PERIOD = 720           # 12ì‹œê°„ (ë¶„ ë‹¨ìœ„)
    SURGE_THRESHOLD = 1.001   # +0.1% ê¸‰ë“± ê¸°ì¤€
    
    def __init__(self, fx_data_feed):
        self.fx_feed = fx_data_feed
        self.blocked_count = 0
        self.last_check_result = None
    
    def is_entry_allowed(self) -> bool:
        """ì§„ì… í—ˆìš© ì—¬ë¶€ ì²´í¬"""
        current_rate = self.fx_feed.get_current_rate()
        ma_12h = self.fx_feed.get_ma(self.MA_PERIOD)
        
        threshold = ma_12h * self.SURGE_THRESHOLD
        is_blocked = current_rate > threshold
        
        if is_blocked:
            self.blocked_count += 1
            surge_pct = ((current_rate / ma_12h) - 1) * 100
            print(f"â›” FX Filter: {current_rate:.2f} > {threshold:.2f} (+{surge_pct:.2f}%)")
        
        self.last_check_result = {
            'timestamp': datetime.now(),
            'current_rate': current_rate,
            'ma_12h': ma_12h,
            'threshold': threshold,
            'is_blocked': is_blocked
        }
        
        return not is_blocked
    
    def get_risk_level(self) -> str:
        """í˜„ì¬ í™˜ìœ¨ ë¦¬ìŠ¤í¬ ë ˆë²¨"""
        if not self.last_check_result:
            return "UNKNOWN"
        
        surge_pct = (
            (self.last_check_result['current_rate'] / 
             self.last_check_result['ma_12h']) - 1
        ) * 100
        
        if surge_pct > 0.3:
            return "HIGH"      # 0.3% ì´ìƒ ê¸‰ë“±
        elif surge_pct > 0.1:
            return "MEDIUM"    # 0.1~0.3% ê¸‰ë“±
        elif surge_pct > 0:
            return "LOW"       # 0~0.1% ìƒìŠ¹
        else:
            return "SAFE"      # í•˜ë½ ë˜ëŠ” ì•ˆì •
```

### 2.3 í™˜ìœ¨ í•„í„° í†µê³„

```sql
-- í™˜ìœ¨ í•„í„° íš¨ê³¼ ë¶„ì„ ì¿¼ë¦¬
SELECT 
    DATE(timestamp) AS date,
    COUNT(*) AS total_signals,
    SUM(CASE WHEN is_blocked THEN 1 ELSE 0 END) AS blocked_count,
    ROUND(
        SUM(CASE WHEN is_blocked THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 
        2
    ) AS block_rate_pct
FROM fx_filter_log
GROUP BY DATE(timestamp)
ORDER BY date DESC;
```

---

## 3. í¬ì§€ì…˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬

### 3.1 Dual Track ì²­ì‚° ì‹œìŠ¤í…œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Position Exit Risk Management                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   Track A: ì •ìƒ ìµì ˆ (Target Hit)                                    â”‚
â”‚   â”œâ”€ ì¡°ê±´: ìˆ˜ìµë¥  â‰¥ 0.7%                                            â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ì—†ìŒ (ì •ìƒ ìˆ˜ìµ ì‹¤í˜„)                                   â”‚
â”‚   â””â”€ ì˜ˆìƒ ë¹„ìœ¨: ~44% (ë°±í…ŒìŠ¤íŠ¸ ê¸°ì¤€)                                 â”‚
â”‚                                                                       â”‚
â”‚   Track B: Breakout Rescue (Ver 3.0)                                 â”‚
â”‚   â”œâ”€ ì¡°ê±´: ìˆ˜ìµë¥  â‰¥ 0.48% AND ê¹€í”„ > BB ìƒë‹¨                        â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ì•½ìˆ˜ìµ (ìˆœìµ 0.1%)                                      â”‚
â”‚   â”œâ”€ ì˜ë¯¸: "Lìí˜• ì¥ì„¸ íƒˆì¶œêµ¬"                                       â”‚
â”‚   â””â”€ ì˜ˆìƒ ë¹„ìœ¨: ~56% (ë°±í…ŒìŠ¤íŠ¸ ê¸°ì¤€)                                 â”‚
â”‚                                                                       â”‚
â”‚   â€» ì†ì ˆ ì—†ìŒ â†’ 100% ìˆ˜ìµ ì²­ì‚° (Target ë˜ëŠ” Breakout)               â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì¥ê¸° ë³´ìœ  ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„°ë§

```python
class PositionRiskMonitor:
    """í¬ì§€ì…˜ ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„°"""
    
    # ê²½ê³  ê¸°ì¤€
    HOLDING_WARNING_HOURS = 24      # 24ì‹œê°„ ë³´ìœ  ì‹œ ê²½ê³ 
    HOLDING_CRITICAL_HOURS = 72     # 72ì‹œê°„ ë³´ìœ  ì‹œ ìœ„í—˜
    
    def __init__(self, position):
        self.position = position
        self.alerts_sent = set()
    
    def check_holding_risk(self) -> dict:
        """ë³´ìœ  ì‹œê°„ ë¦¬ìŠ¤í¬ ì²´í¬"""
        holding_hours = self._get_holding_hours()
        
        status = {
            'holding_hours': holding_hours,
            'risk_level': 'NORMAL',
            'action': None
        }
        
        if holding_hours >= self.HOLDING_CRITICAL_HOURS:
            status['risk_level'] = 'CRITICAL'
            status['action'] = 'Breakout ì¡°ê±´ ì™„í™” ê²€í† '
            self._send_alert('CRITICAL', holding_hours)
        
        elif holding_hours >= self.HOLDING_WARNING_HOURS:
            status['risk_level'] = 'WARNING'
            status['action'] = 'ëª¨ë‹ˆí„°ë§ ê°•í™”'
            self._send_alert('WARNING', holding_hours)
        
        return status
    
    def check_drawdown(self, current_kimp: float) -> dict:
        """ì†ì‹¤í­(Drawdown) ì²´í¬"""
        entry_kimp = self.position.entry_kimp
        drawdown = entry_kimp - current_kimp
        drawdown_pct = drawdown  # ê¹€í”„ ìì²´ê°€ %
        
        # ì†ì ˆ ì—†ì§€ë§Œ ëª¨ë‹ˆí„°ë§ì€ í•„ìš”
        status = {
            'drawdown_pct': drawdown_pct,
            'risk_level': 'NORMAL'
        }
        
        if drawdown_pct > 1.0:  # 1% ì´ìƒ ì—­ê¹€í”„
            status['risk_level'] = 'ELEVATED'
        
        if drawdown_pct > 2.0:  # 2% ì´ìƒ ì—­ê¹€í”„
            status['risk_level'] = 'HIGH'
        
        return status
    
    def _get_holding_hours(self) -> float:
        elapsed = datetime.now() - self.position.entry_timestamp
        return elapsed.total_seconds() / 3600
    
    def _send_alert(self, level: str, hours: float):
        alert_key = f"{level}_{int(hours // 24)}"
        if alert_key not in self.alerts_sent:
            # Telegram ì•Œë¦¼ ì „ì†¡
            self.alerts_sent.add(alert_key)
```

---

## 4. ì‹¤í–‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬

### 4.1 ë™ì‹œ ì£¼ë¬¸ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Execution Risk Scenarios                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   ì‹œë‚˜ë¦¬ì˜¤ 1: Upbitë§Œ ì²´ê²°                                           â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ë¸íƒ€ ë…¸ì¶œ (í˜„ë¬¼ë§Œ ë³´ìœ )                                 â”‚
â”‚   â””â”€ ëŒ€ì‘: ì¦‰ì‹œ Upbit ë°˜ëŒ€ë§¤ë§¤ (ì†ì‹¤ ìµœì†Œí™”)                         â”‚
â”‚                                                                       â”‚
â”‚   ì‹œë‚˜ë¦¬ì˜¤ 2: Binanceë§Œ ì²´ê²°                                         â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ìˆ í¬ì§€ì…˜ë§Œ ë³´ìœ  (ë°©í–¥ì„± ë¦¬ìŠ¤í¬)                        â”‚
â”‚   â””â”€ ëŒ€ì‘: ì¦‰ì‹œ Binance í¬ì§€ì…˜ ì²­ì‚°                                  â”‚
â”‚                                                                       â”‚
â”‚   ì‹œë‚˜ë¦¬ì˜¤ 3: ì–‘ìª½ ë¶€ë¶„ ì²´ê²°                                         â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ë¶ˆê· í˜• ë¸íƒ€                                             â”‚
â”‚   â””â”€ ëŒ€ì‘: ì‘ì€ ìª½ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì • í›„ ë‚˜ë¨¸ì§€ ì²­ì‚°                      â”‚
â”‚                                                                       â”‚
â”‚   ì‹œë‚˜ë¦¬ì˜¤ 4: ì²­ì‚° ì¤‘ í•œìª½ ì‹¤íŒ¨                                      â”‚
â”‚   â”œâ”€ ë¦¬ìŠ¤í¬: ë¶ˆì™„ì „ ì²­ì‚° (í•œìª½ë§Œ í¬ì§€ì…˜ ë‚¨ìŒ)                        â”‚
â”‚   â””â”€ ëŒ€ì‘: ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ) â†’ ìˆ˜ë™ ê°œì… ì•Œë¦¼                        â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ë¡¤ë°± ë©”ì»¤ë‹ˆì¦˜

```python
class ExecutionRiskManager:
    """ì‹¤í–‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬ì"""
    
    MAX_RETRIES = 3
    RETRY_DELAY = 1.0
    
    async def safe_execute_entry(self, signal) -> dict:
        """ì•ˆì „í•œ ì§„ì… ì‹¤í–‰"""
        
        # ë™ì‹œ ì‹¤í–‰
        results = await asyncio.gather(
            self._execute_upbit(signal),
            self._execute_binance(signal),
            return_exceptions=True
        )
        
        upbit_result, binance_result = results
        
        # ì–‘ìª½ ì„±ê³µ
        if not isinstance(upbit_result, Exception) and \
           not isinstance(binance_result, Exception):
            return {'success': True, 'results': results}
        
        # ë¡¤ë°± í•„ìš”
        await self._rollback(upbit_result, binance_result)
        
        return {
            'success': False,
            'error': f"Upbit: {upbit_result}, Binance: {binance_result}"
        }
    
    async def _rollback(self, upbit_result, binance_result):
        """ë¡¤ë°± ì‹¤í–‰"""
        
        if not isinstance(upbit_result, Exception):
            # Upbitë§Œ ì²´ê²° â†’ ë°˜ëŒ€ë§¤ë§¤
            for attempt in range(self.MAX_RETRIES):
                try:
                    await self.upbit.create_market_sell_order(
                        symbol='BTC/KRW',
                        amount=upbit_result['filled']
                    )
                    print(f"âœ… Upbit rollback success")
                    break
                except Exception as e:
                    print(f"âš ï¸ Upbit rollback attempt {attempt + 1} failed: {e}")
                    await asyncio.sleep(self.RETRY_DELAY)
        
        if not isinstance(binance_result, Exception):
            # Binanceë§Œ ì²´ê²° â†’ í¬ì§€ì…˜ ì²­ì‚°
            for attempt in range(self.MAX_RETRIES):
                try:
                    await self.binance.create_market_buy_order(
                        symbol='BTC/USDT:USDT',
                        amount=binance_result['filled'],
                        params={'reduceOnly': True}
                    )
                    print(f"âœ… Binance rollback success")
                    break
                except Exception as e:
                    print(f"âš ï¸ Binance rollback attempt {attempt + 1} failed: {e}")
                    await asyncio.sleep(self.RETRY_DELAY)
```

---

## 5. ìê¸ˆ ê´€ë¦¬ ë¦¬ìŠ¤í¬

### 5.1 ìë³¸ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Capital Structure                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   ì´ ìë³¸: 4,000ë§Œì›                                                 â”‚
â”‚   â”œâ”€â”€ ì˜ˆë¹„ë¹„: 200ë§Œì› (5%)                                          â”‚
â”‚   â”‚   â””â”€ ìš©ë„: ìˆ˜ìˆ˜ë£Œ, ìŠ¬ë¦¬í”¼ì§€, ê¸´ê¸‰ ìê¸ˆ                          â”‚
â”‚   â”‚                                                                   â”‚
â”‚   â””â”€â”€ ìš´ìš© ìë³¸: 3,800ë§Œì› (95%)                                    â”‚
â”‚       â”œâ”€â”€ Upbit (í˜„ë¬¼): 1,900ë§Œì› (50%)                             â”‚
â”‚       â””â”€â”€ Binance (ì„ ë¬¼): 1,900ë§Œì› (50%)                           â”‚
â”‚                                                                       â”‚
â”‚   í¬ì§€ì…˜ ìµœëŒ€ ìê¸ˆ:                                                  â”‚
â”‚   â”œâ”€â”€ Level 1: 1,520ë§Œì› (40%)                                      â”‚
â”‚   â”œâ”€â”€ Level 2: 2,280ë§Œì› (60%)                                      â”‚
â”‚   â””â”€â”€ Combined: 3,800ë§Œì› (100%)                                    â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ìê¸ˆ ë¬¶ì„ ì‹œë‚˜ë¦¬ì˜¤

```python
class CapitalRiskManager:
    """ìê¸ˆ ë¦¬ìŠ¤í¬ ê´€ë¦¬ì"""
    
    def calculate_capital_at_risk(self, position) -> dict:
        """ë¬¶ì¸ ìê¸ˆ ê³„ì‚°"""
        
        total_capital = 40_000_000
        invested = position.total_invested if position else 0
        available = total_capital - invested
        
        return {
            'total': total_capital,
            'invested': invested,
            'available': available,
            'invested_pct': (invested / total_capital) * 100,
            'available_pct': (available / total_capital) * 100
        }
    
    def estimate_holding_cost(self, position) -> dict:
        """ë³´ìœ  ë¹„ìš© ì¶”ì •"""
        
        holding_hours = self._get_holding_hours(position)
        
        # í€ë”©ë¹„ (Binance ì„ ë¬¼)
        # 8ì‹œê°„ë§ˆë‹¤ ë°œìƒ, í‰ê·  Â±0.01%
        funding_periods = holding_hours / 8
        estimated_funding = position.binance_amount * 0.0001 * funding_periods
        
        # ê¸°íšŒë¹„ìš© (ì—° 5% ê¸°ì¤€)
        opportunity_cost = position.total_invested * 0.05 * (holding_hours / 8760)
        
        return {
            'holding_hours': holding_hours,
            'estimated_funding_cost': estimated_funding,
            'opportunity_cost': opportunity_cost,
            'total_holding_cost': estimated_funding + opportunity_cost
        }
```

---

## 6. ë¦¬ìŠ¤í¬ ëŒ€ì‹œë³´ë“œ

### 6.1 ì‹¤ì‹œê°„ ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„°ë§

```python
class RiskDashboard:
    """ë¦¬ìŠ¤í¬ ëŒ€ì‹œë³´ë“œ"""
    
    def __init__(self, fx_manager, position_monitor, capital_manager):
        self.fx = fx_manager
        self.position = position_monitor
        self.capital = capital_manager
    
    def get_overall_risk_status(self) -> dict:
        """ì¢…í•© ë¦¬ìŠ¤í¬ ìƒíƒœ"""
        
        return {
            'timestamp': datetime.now().isoformat(),
            
            # í™˜ìœ¨ ë¦¬ìŠ¤í¬
            'fx_risk': {
                'level': self.fx.get_risk_level(),
                'is_entry_allowed': self.fx.is_entry_allowed(),
                'blocked_count_today': self.fx.blocked_count
            },
            
            # í¬ì§€ì…˜ ë¦¬ìŠ¤í¬
            'position_risk': self.position.check_holding_risk() if self.position.position else None,
            
            # ìê¸ˆ ë¦¬ìŠ¤í¬
            'capital_risk': self.capital.calculate_capital_at_risk(
                self.position.position
            ),
            
            # ì¢…í•© ìƒíƒœ
            'overall': self._calculate_overall_risk()
        }
    
    def _calculate_overall_risk(self) -> str:
        """ì¢…í•© ë¦¬ìŠ¤í¬ ë ˆë²¨ ê³„ì‚°"""
        
        fx_level = self.fx.get_risk_level()
        
        if fx_level == 'HIGH':
            return 'HIGH'
        
        if self.position.position:
            pos_risk = self.position.check_holding_risk()
            if pos_risk['risk_level'] == 'CRITICAL':
                return 'HIGH'
            elif pos_risk['risk_level'] == 'WARNING':
                return 'MEDIUM'
        
        return 'LOW'
```

### 6.2 Telegram ë¦¬ìŠ¤í¬ ì•Œë¦¼

```python
async def send_risk_alert(bot, chat_id, risk_status: dict):
    """ë¦¬ìŠ¤í¬ ì•Œë¦¼ ì „ì†¡"""
    
    overall = risk_status['overall']
    
    if overall == 'HIGH':
        emoji = "ğŸ”´"
    elif overall == 'MEDIUM':
        emoji = "ğŸŸ¡"
    else:
        emoji = "ğŸŸ¢"
    
    text = f"{emoji} *ë¦¬ìŠ¤í¬ ìƒíƒœ: {overall}*\n\n"
    
    # í™˜ìœ¨ ë¦¬ìŠ¤í¬
    fx = risk_status['fx_risk']
    text += f"ğŸ“Š *í™˜ìœ¨*: {fx['level']}\n"
    text += f"   ì§„ì… ê°€ëŠ¥: {'âœ…' if fx['is_entry_allowed'] else 'â›”'}\n"
    
    # í¬ì§€ì…˜ ë¦¬ìŠ¤í¬
    if risk_status['position_risk']:
        pos = risk_status['position_risk']
        text += f"\nğŸ“ˆ *í¬ì§€ì…˜*: {pos['risk_level']}\n"
        text += f"   ë³´ìœ  ì‹œê°„: {pos['holding_hours']:.1f}ì‹œê°„\n"
    
    # ìê¸ˆ ë¦¬ìŠ¤í¬
    cap = risk_status['capital_risk']
    text += f"\nğŸ’° *ìê¸ˆ*\n"
    text += f"   íˆ¬ì…: {cap['invested']:,.0f}ì› ({cap['invested_pct']:.1f}%)\n"
    text += f"   ê°€ìš©: {cap['available']:,.0f}ì› ({cap['available_pct']:.1f}%)\n"
    
    await bot.send_message(chat_id, text, parse_mode='Markdown')
```

---

## 7. ë¦¬ìŠ¤í¬ íŒŒë¼ë¯¸í„° ì„¤ì •

```yaml
# config/risk_config.yaml
risk_management:
  version: "3.0"
  
  # í™˜ìœ¨ í•„í„°
  fx_filter:
    enabled: true
    ma_period_minutes: 720  # 12ì‹œê°„
    surge_threshold: 1.001  # +0.1%
  
  # í¬ì§€ì…˜ ë¦¬ìŠ¤í¬
  position:
    holding_warning_hours: 24
    holding_critical_hours: 72
    drawdown_warning_pct: 1.0
    drawdown_critical_pct: 2.0
  
  # ì‹¤í–‰ ë¦¬ìŠ¤í¬
  execution:
    max_retries: 3
    retry_delay_seconds: 1.0
    rollback_enabled: true
  
  # ìê¸ˆ ë¦¬ìŠ¤í¬
  capital:
    reserve_ratio: 0.05
    max_position_ratio: 0.95
  
  # ì•Œë¦¼
  alerts:
    telegram_enabled: true
    risk_check_interval_seconds: 60
```

---

**ë²„ì „**: 3.0  
**ì‘ì„±ì¼**: 2025-12-14  
**ë ˆí¬**: trading-platform-portfolio
